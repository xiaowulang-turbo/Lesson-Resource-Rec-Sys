# 推荐系统缓存迁移到 Redis

本文档描述了将推荐系统的内存缓存迁移到 Redis 缓存服务的过程。

## 迁移背景

原先的推荐系统使用内存缓存（`CacheService.js`）来存储推荐结果，这种方式有以下限制：

1. 缓存数据随服务器重启而丢失
2. 无法在多个服务器实例之间共享缓存
3. 内存使用量随着缓存增长而无限增长
4. 无法设置更精细的缓存策略

为了解决这些问题，我们将缓存系统迁移到 Redis，这是一个高性能的键值存储系统，具有以下优点：

1. 持久化缓存数据，服务器重启不会丢失
2. 可在多个服务器实例之间共享
3. 内置的内存管理和过期策略
4. 多种数据结构和高级功能
5. 高性能和可扩展性

## 主要更改

1. 安装 Redis 客户端依赖：

    ```bash
    npm install redis
    ```

2. 创建新的`RedisCacheService.js`服务，实现与原有`CacheService.js`相同的 API，但使用 Redis 存储数据

3. 更新依赖于缓存服务的控制器（主要是`recommendationController.js`）以使用异步 Redis 调用

4. 更新应用程序入口文件，正确处理 Redis 连接和关闭

5. 创建测试脚本和命令，用于验证 Redis 缓存服务的功能

## 配置说明

Redis 连接配置通过环境变量设置：

-   `REDIS_URL`: Redis 服务器连接 URL，默认为`redis://localhost:6379`
-   `REDIS_TTL`: 默认缓存过期时间（秒），默认为 3600 秒（1 小时）

**重要**：需要在服务器上安装并运行 Redis 服务。

## 使用方法

1. 确保 Redis 服务器已安装并运行：

    ```bash
    # Ubuntu/Debian
    sudo systemctl status redis-server

    # 如果未运行，启动服务
    sudo systemctl start redis-server
    ```

2. 测试 Redis 缓存服务：

    ```bash
    npm run test:redis
    ```

3. 启动服务器：
    ```bash
    npm run dev
    ```

## 与原缓存服务的差异

1. **异步 API**：所有缓存操作现在都是异步的，需要使用`await`关键字
2. **时间单位**：Redis 缓存的 TTL 使用秒为单位，而不是毫秒
3. **自动清理**：Redis 会自动清理过期的键，不需要手动调用`cleanup()`方法
4. **连接管理**：Redis 需要建立和管理连接，服务包含连接重试和错误处理机制

## 常见问题

1. **Redis 连接错误**：确保 Redis 服务器正在运行，并且连接 URL 正确
2. **数据序列化/反序列化问题**：Redis 只能存储字符串，所有复杂对象都会通过 JSON 序列化/反序列化

## 后续优化方向

1. 实现缓存预热机制，在服务启动时预加载热门推荐
2. 使用 Redis 的 Pipeline 功能批量处理缓存操作
3. 实现更细粒度的缓存策略，如基于用户活跃度的差异化过期时间
4. 添加缓存命中率监控和性能指标
